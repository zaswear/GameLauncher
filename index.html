<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MyGameVault</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;800&display=swap');
        body { font-family: 'Poppins', sans-serif; background-color: #0d1117; color: #e6e6e6; }
        .spinner { border: 3px solid rgba(255, 255, 255, 0.3); border-top: 3px solid #818cf8; border-radius: 50%; width: 16px; height: 16px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #discover-card { transition: transform 0.4s ease, opacity 0.4s ease; cursor: grab; }
        .modal-enter { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .metascore-good { background-color: #6c3; color: white; }
        .metascore-average { background-color: #fc3; color: white; }
        .metascore-bad { background-color: #f00; color: white; }
        .view-btn { transition: all 0.2s ease-in-out; }
        .view-btn.active { background-color: #4f46e5; color: white; }
        .view-btn:not(.active) { background-color: #374151; }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8 flex flex-col">

    <main class="max-w-4xl mx-auto w-full flex-grow">
        <header class="mb-8 text-center">
            <div class="flex items-center justify-center gap-4">
                <svg class="w-12 h-12 text-indigo-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z" /></svg>
                <h1 class="text-4xl md:text-6xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-purple-500">
                    MyGameVault
                </h1>
            </div>
        </header>

        <section id="discover-section" class="mb-12 flex flex-col items-center">
            <div id="discover-card-container" class="relative w-full max-w-sm h-96">
                <div class="bg-gray-800 rounded-lg flex flex-col items-center justify-center h-full text-center p-4">
                    <span class="spinner mb-4"></span>
                    <p class="text-gray-400">Cargando juegos para descubrir...</p>
                </div>
            </div>
            <div id="discover-buttons" class="flex items-center gap-4 mt-6">
                <button id="dislike-btn" class="w-20 h-20 bg-red-800/20 text-red-400 rounded-full flex items-center justify-center text-4xl font-bold transition-transform hover:scale-110 hover:bg-red-800/40">‚ùå</button>
                <button id="wishlist-btn" class="w-16 h-16 bg-yellow-800/20 text-yellow-400 rounded-full flex items-center justify-center text-3xl font-bold transition-transform hover:scale-110 hover:bg-yellow-800/40">‚≠ê</button>
                <button id="like-btn" class="w-20 h-20 bg-green-800/20 text-green-400 rounded-full flex items-center justify-center text-4xl font-bold transition-transform hover:scale-110 hover:bg-green-800/40">üíö</button>
            </div>
        </section>

        <section id="library-section">
            <div class="border-b-2 border-gray-700 pb-2 mb-6">
                <div class="flex flex-col sm:flex-row justify-between items-center mb-4 gap-4">
                     <div class="flex p-1 bg-gray-800 rounded-lg">
                        <button id="show-vault-btn" class="view-btn px-4 py-2 rounded-md text-sm font-semibold">Mi B√≥veda</button>
                        <button id="show-wishlist-btn" class="view-btn px-4 py-2 rounded-md text-sm font-semibold">Lista de Deseados</button>
                    </div>
                    <button id="export-btn" class="text-sm bg-gray-700 hover:bg-indigo-600 p-2 rounded-md transition-colors" title="Exportar a .txt">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"></path></svg>
                    </button>
                </div>
                <div class="flex flex-col md:flex-row gap-4">
                    <input type="text" id="library-search" placeholder="Buscar en la lista actual..." class="w-full md:flex-grow p-3 rounded-lg bg-gray-800 text-white border-2 border-gray-700 focus:border-indigo-500 transition">
                    <select id="genre-filter" class="p-3 rounded-lg bg-gray-800 text-white border-2 border-gray-700 focus:border-indigo-500 transition"></select>
                </div>
            </div>
            <div id="library-grid-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4"></div>
        </section>
        
        <div id="details-panel" class="hidden fixed inset-0 bg-black bg-opacity-75 backdrop-blur-sm flex items-center justify-center p-4 z-50"></div>
    </main>

    <script type="module">
        let discoverGames = [], likedGames = [], dislikedGames = [], wishlistedGames = [], currentIndex = 0;
        let currentView = 'vault';

        function renderNextCard() {
            const container = document.getElementById('discover-card-container');
            if (currentIndex >= discoverGames.length) {
                container.innerHTML = `<div class="bg-gray-800 rounded-lg flex flex-col items-center justify-center h-full text-center p-4"><h3 class="text-2xl font-bold text-white mb-2">¬°Has visto todo!</h3><p class="text-gray-400">Recarga la p√°gina para obtener una nueva selecci√≥n.</p></div>`;
                document.getElementById('discover-buttons').style.display = 'none';
                return;
            }
            const game = discoverGames[currentIndex];
            container.innerHTML = `<div id="discover-card" class="absolute inset-0 bg-gray-800 rounded-lg shadow-2xl overflow-hidden"><img src="${game.imageUrl}" class="w-full h-full object-cover"><div class="absolute bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-black to-transparent"><h3 class="text-2xl font-bold text-white">${game.title}</h3></div></div>`;
        }

        function handleSwipe(action) {
            const cardElement = document.getElementById('discover-card');
            if (!cardElement || currentIndex >= discoverGames.length) return;
            const game = discoverGames[currentIndex];
            
            let transform = '';
            if (action === 'like') {
                likedGames.unshift(game);
                localStorage.setItem('likedGames', JSON.stringify(likedGames));
                transform = 'translateX(100px) rotate(15deg)';
            } else if (action === 'dislike') {
                dislikedGames.push(game.id);
                localStorage.setItem('dislikedGames', JSON.stringify(dislikedGames));
                transform = 'translateX(-100px) rotate(-15deg)';
            } else if (action === 'wishlist') {
                wishlistedGames.unshift(game);
                localStorage.setItem('wishlistedGames', JSON.stringify(wishlistedGames));
                transform = 'translateY(-100px) rotate(0deg)';
            }
            
            if (currentView === 'vault' && action === 'like') renderMyLibrary();
            if (currentView === 'wishlist' && action === 'wishlist') renderMyLibrary();
            populateGenreFilter();

            cardElement.style.transform = transform;
            cardElement.style.opacity = '0';
            currentIndex++;
            setTimeout(renderNextCard, 200);
        }

        function renderMyLibrary() {
            const listToRender = currentView === 'vault' ? likedGames : wishlistedGames;
            const container = document.getElementById('library-grid-container');
            const searchTerm = document.getElementById('library-search').value.toLowerCase();
            const selectedGenre = document.getElementById('genre-filter').value;
            
            let filteredList = listToRender;
            if (searchTerm) filteredList = filteredList.filter(game => game.title.toLowerCase().includes(searchTerm));
            if (selectedGenre) filteredList = filteredList.filter(game => game.genres.includes(selectedGenre));

            container.innerHTML = '';
            if (filteredList.length === 0) {
                const message = currentView === 'vault' ? 'Tu b√≥veda est√° vac√≠a.' : 'Tu lista de deseados est√° vac√≠a.';
                container.innerHTML = `<p class="col-span-full text-center text-gray-500 py-10">${message}</p>`;
            } else {
                filteredList.forEach(game => {
                    const card = document.createElement('div');
                    card.className = 'cursor-pointer group transition-all duration-300 hover:scale-105 hover:shadow-2xl hover:shadow-indigo-500/20';
                    card.innerHTML = `<img src="${game.imageUrl}" alt="${game.title}" class="rounded-lg shadow-lg w-full h-auto aspect-[3/4] object-cover border-2 border-transparent group-hover:border-indigo-500">`;
                    card.onclick = () => toggleDetails(game.id);
                    container.appendChild(card);
                });
            }
        }
        
        function populateGenreFilter() {
            const filter = document.getElementById('genre-filter');
            const listToFilter = currentView === 'vault' ? likedGames : wishlistedGames;
            const genres = new Set();
            listToFilter.forEach(game => game.genres.forEach(genre => genres.add(genre)));
            const currentVal = filter.value;
            filter.innerHTML = '<option value="">Todos los g√©neros</option>';
            [...genres].sort().forEach(genre => { filter.innerHTML += `<option value="${genre}">${genre}</option>`; });
            filter.value = currentVal;
        }

        function deleteFromLibrary(gameId) {
            if (currentView === 'vault') {
                likedGames = likedGames.filter(game => game.id !== gameId);
                localStorage.setItem('likedGames', JSON.stringify(likedGames));
            } else {
                wishlistedGames = wishlistedGames.filter(game => game.id !== gameId);
                localStorage.setItem('wishlistedGames', JSON.stringify(wishlistedGames));
            }
            renderMyLibrary();
            populateGenreFilter();
            toggleDetails();
        }
        
        async function toggleDetails(gameId) {
            const detailsPanel = document.getElementById('details-panel');
            const isOpen = !detailsPanel.classList.contains('hidden');
            if (isOpen || !gameId) { detailsPanel.classList.add('hidden'); detailsPanel.innerHTML = ''; return; }

            detailsPanel.innerHTML = `<div class="w-full max-w-5xl text-center py-20 text-lg text-indigo-400">Cargando detalles... <span class="spinner inline-block ml-2"></span></div>`;
            detailsPanel.classList.remove('hidden');

            try {
                const response = await fetch(`/api/getGameDetails?id=${gameId}`);
                if (!response.ok) throw new Error('No se pudieron cargar los detalles.');
                const details = await response.json();
                
                let scoreClass = 'metascore-average';
                if (details.metacritic >= 75) scoreClass = 'metascore-good';
                if (details.metacritic < 50 && details.metacritic > 0) scoreClass = 'metascore-bad';

                detailsPanel.innerHTML = `
                    <div class="relative w-full max-w-5xl bg-gray-800 border border-gray-700 rounded-xl shadow-2xl p-6 m-4 modal-enter max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                        <button onclick="window.toggleDetails()" class="absolute top-2 right-4 text-3xl font-light text-gray-400 hover:text-white">&times;</button>
                        <h2 class="text-4xl lg:text-6xl font-bold text-white mb-4">${details.name}</h2>
                        <div class="flex flex-col lg:flex-row gap-6">
                            <div class="w-full lg:w-2/5 flex-shrink-0">
                                <img src="${details.background_image}" class="rounded-lg shadow-lg w-full mb-4">
                                <div class="space-y-3">
                                    ${details.metacritic ? `<div class="flex items-center gap-2"><svg class="w-6 h-6" viewBox="0 0 100 100"><circle cx="50" cy="50" r="50" fill="#242424"/><path d="M78.62 21.38V78.62H21.38V21.38H78.62ZM87.5 12.5H12.5V87.5H87.5V12.5Z" fill="white"/><path d="M45.56 65.5V36.68H38.3V30H61.7V36.68H54.44V65.5H45.56Z" fill="white"/></svg><span class="font-bold text-gray-300">Metacritic</span><span class="font-bold text-lg px-2 rounded ${scoreClass}">${details.metacritic}</span></div>` : ''}
                                    ${details.stores?.find(s => s.store.slug === 'steam') ? `<a href="${details.stores.find(s => s.store.slug === 'steam').url}" target="_blank" class="block w-full text-center bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg">Ver en Steam</a>` : ''}
                                    <button id="delete-btn" class="w-full bg-red-800 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg">Eliminar de esta lista</button>
                                </div>
                            </div>
                            <div class="w-full lg:w-3/5">
                                <h3 class="font-bold text-xl mb-2 text-indigo-400">Acerca de</h3>
                                <div class="text-gray-300 text-sm max-h-48 overflow-y-auto mb-4">${details.description_raw || 'Sin descripci√≥n.'}</div>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-2">${details.short_screenshots?.slice(0, 4).map(ss => `<img src="${ss.image}" class="rounded-md h-24 w-full object-cover">`).join('') || ''}</div>
                            </div>
                        </div>
                    </div>
                `;
                detailsPanel.onclick = () => toggleDetails();
                document.getElementById('delete-btn').onclick = () => deleteFromLibrary(gameId);
            } catch (error) { detailsPanel.innerHTML = `<div class="relative w-full max-w-md bg-gray-800 p-6 rounded-xl"><p class="text-red-400">Error: ${error.message}</p><button onclick="window.toggleDetails()" class="mt-4 bg-indigo-600 px-4 py-2 rounded">Cerrar</button></div>`; }
        }
        window.toggleDetails = toggleDetails;

        function exportLibraryToTxt() {
            const listToExport = currentView === 'vault' ? likedGames : wishlistedGames;
            const title = currentView === 'vault' ? 'Mi B√≥veda de Juegos' : 'Mi Lista de Deseados';
            if (listToExport.length === 0) { alert('La lista actual est√° vac√≠a.'); return; }
            const textContent = `${title}\n\n` + listToExport.map(g => `- ${g.title}`).join('\n');
            const blob = new Blob([textContent], { type: 'text/plain;charset=utf-8' });
            const anchor = document.createElement('a');
            anchor.download = `${title.replace(/\s/g, '_')}.txt`;
            anchor.href = window.URL.createObjectURL(blob);
            anchor.click();
            window.URL.revokeObjectURL(anchor.href);
        }

        async function main() {
            // Asignaci√≥n de eventos
            document.getElementById('like-btn').onclick = () => handleSwipe('like');
            document.getElementById('dislike-btn').onclick = () => handleSwipe('dislike');
            document.getElementById('wishlist-btn').onclick = () => handleSwipe('wishlist');
            document.getElementById('library-search').oninput = renderMyLibrary;
            document.getElementById('genre-filter').onchange = renderMyLibrary;
            document.getElementById('export-btn').onclick = exportLibraryToTxt;
            document.addEventListener('keydown', (e) => { if (e.key === 'ArrowLeft') handleSwipe('dislike'); if (e.key === 'ArrowRight') handleSwipe('like'); });

            const vaultBtn = document.getElementById('show-vault-btn');
            const wishlistBtn = document.getElementById('show-wishlist-btn');

            vaultBtn.onclick = () => {
                currentView = 'vault';
                vaultBtn.classList.add('active');
                wishlistBtn.classList.remove('active');
                renderMyLibrary();
                populateGenreFilter();
            };
            wishlistBtn.onclick = () => {
                currentView = 'wishlist';
                wishlistBtn.classList.add('active');
                vaultBtn.classList.remove('active');
                renderMyLibrary();
                populateGenreFilter();
            };

            // Carga de datos inicial
            likedGames = JSON.parse(localStorage.getItem('likedGames')) || [];
            dislikedGames = JSON.parse(localStorage.getItem('dislikedGames')) || [];
            wishlistedGames = JSON.parse(localStorage.getItem('wishlistedGames')) || [];
            
            vaultBtn.classList.add('active'); // Iniciar en la vista de la b√≥veda
            renderMyLibrary();
            populateGenreFilter();

            try {
                const response = await fetch(`/api/getDiscoverGames?cacheBust=${new Date().getTime()}`);
                if (!response.ok) throw new Error('No se pudo cargar la lista de juegos para descubrir.');
                const allFetchedGames = await response.json();
                const seenGames = new Set([...dislikedGames, ...likedGames.map(g => g.id), ...wishlistedGames.map(g => g.id)]);
                discoverGames = allFetchedGames.filter(game => !seenGames.has(game.id));
                renderNextCard();
            } catch (error) {
                console.error(error);
                document.getElementById('discover-card-container').innerHTML = `<div class="bg-gray-800 rounded-lg flex items-center justify-center h-full text-center p-4"><p class="text-red-400">${error.message}</p></div>`;
            }
        }

        main();
    </script>
</body>
</html>