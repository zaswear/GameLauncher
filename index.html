<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Zaswear Mix&Game</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #0d1117; color: #e6e6e6; }
        .spinner { border: 3px solid rgba(255, 255, 255, 0.3); border-top: 3px solid #818cf8; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #discover-card { transition: transform 0.3s ease, opacity 0.3s ease; }
        .modal-enter { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8 flex flex-col">

    <main class="max-w-4xl mx-auto w-full flex-grow">
        <header class="mb-8 text-center">
            <h1 class="text-4xl md:text-6xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-purple-500">
                Zaswear Mix&Game
            </h1>
            <p class="text-gray-400 mt-2">Descubre y guarda tus pr√≥ximos juegos favoritos</p>
        </header>

        <section id="discover-section" class="mb-12 flex flex-col items-center">
            <div id="discover-card-container" class="relative w-full max-w-sm h-96">
                </div>
            <div id="discover-buttons" class="flex gap-8 mt-6">
                <button id="dislike-btn" class="w-20 h-20 bg-red-800/20 text-red-400 rounded-full flex items-center justify-center text-4xl font-bold transition-transform hover:scale-110 hover:bg-red-800/40">‚ùå</button>
                <button id="like-btn" class="w-20 h-20 bg-green-800/20 text-green-400 rounded-full flex items-center justify-center text-4xl font-bold transition-transform hover:scale-110 hover:bg-green-800/40">üíö</button>
            </div>
        </section>

        <section id="library-section">
            <h2 class="text-2xl md:text-3xl font-bold text-gray-200 border-b-2 border-gray-700 pb-2 mb-6">
                üìö Tu Biblioteca de Favoritos
            </h2>
            <div id="library-grid-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4">
                </div>
        </section>
        
        <div id="details-panel" class="hidden fixed inset-0 bg-black bg-opacity-75 backdrop-blur-sm flex items-center justify-center p-4 z-50"></div>
    </main>

    <script type="module">
        let discoverGames = [];
        let likedGames = [];
        let dislikedGames = [];
        let currentIndex = 0;

        // --- L√ìGICA PRINCIPAL ---
        
        function renderNextCard() {
            const container = document.getElementById('discover-card-container');
            
            // Si ya hemos visto todos los juegos, mostramos un mensaje
            if (currentIndex >= discoverGames.length) {
                container.innerHTML = `<div class="bg-gray-800 rounded-lg flex flex-col items-center justify-center h-full text-center p-4"><h3 class="text-2xl font-bold text-white mb-2">¬°Has visto todo!</h3><p class="text-gray-400">Recarga la p√°gina para obtener una nueva selecci√≥n de juegos.</p></div>`;
                document.getElementById('discover-buttons').style.display = 'none';
                return;
            }

            const game = discoverGames[currentIndex];
            container.innerHTML = `
                <div id="discover-card" class="absolute inset-0 bg-gray-800 rounded-lg shadow-2xl overflow-hidden">
                    <img src="${game.imageUrl}" class="w-full h-full object-cover">
                    <div class="absolute bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-black to-transparent">
                        <h3 class="text-2xl font-bold text-white">${game.title}</h3>
                    </div>
                </div>
            `;
        }

        function handleSwipe(direction) {
            const cardElement = document.getElementById('discover-card');
            if (!cardElement || currentIndex >= discoverGames.length) return;

            const game = discoverGames[currentIndex];

            if (direction === 'like') {
                likedGames.unshift(game); // A√±adir al principio de la lista
                localStorage.setItem('likedGames', JSON.stringify(likedGames));
                renderMyLibrary();
                cardElement.style.transform = 'translateX(100px) rotate(15deg)';
            } else { // Dislike
                dislikedGames.push(game.id);
                localStorage.setItem('dislikedGames', JSON.stringify(dislikedGames));
                cardElement.style.transform = 'translateX(-100px) rotate(-15deg)';
            }

            cardElement.style.opacity = '0';
            
            currentIndex++;
            setTimeout(renderNextCard, 200); // Peque√±a espera para la animaci√≥n
        }

        function renderMyLibrary() {
            const container = document.getElementById('library-grid-container');
            container.innerHTML = '';

            if (likedGames.length === 0) {
                container.innerHTML = `<p class="col-span-full text-center text-gray-500 py-10">A√∫n no has a√±adido ning√∫n juego. ¬°Usa los botones de arriba para empezar!</p>`;
            }

            likedGames.forEach(game => {
                const card = document.createElement('div');
                card.className = 'cursor-pointer group';
                card.innerHTML = `<img src="${game.imageUrl}" alt="${game.title}" class="rounded-lg shadow-lg w-full h-auto aspect-[3/4] object-cover transition-transform duration-300 group-hover:scale-105 border-2 border-transparent group-hover:border-indigo-500">`;
                card.onclick = () => toggleDetails(game.id);
                container.appendChild(card);
            });
        }
        
        async function toggleDetails(gameId) {
            // ... (c√≥digo del modal de detalles - sin cambios)
        }

        async function main() {
            document.getElementById('like-btn').onclick = () => handleSwipe('like');
            document.getElementById('dislike-btn').onclick = () => handleSwipe('dislike');

            // Atajos de teclado para los botones
            document.addEventListener('keydown', (e) => {
                if (e.key === 'ArrowLeft') handleSwipe('dislike');
                if (e.key === 'ArrowRight') handleSwipe('like');
            });

            // 1. Cargar datos guardados del navegador
            likedGames = JSON.parse(localStorage.getItem('likedGames')) || [];
            dislikedGames = JSON.parse(localStorage.getItem('dislikedGames')) || [];
            renderMyLibrary();

            // 2. Pedir nuevos juegos para descubrir
            try {
                const response = await fetch('/api/getDiscoverGames');
                if (!response.ok) throw new Error('No se pudo cargar la lista de juegos para descubrir.');
                const allFetchedGames = await response.json();
                
                // 3. Filtrar los juegos que ya hemos visto o nos han gustado
                const seenGames = new Set([...dislikedGames, ...likedGames.map(g => g.id)]);
                discoverGames = allFetchedGames.filter(game => !seenGames.has(game.id));
                
                renderNextCard();
            } catch (error) {
                console.error(error);
                document.getElementById('discover-card-container').innerHTML = `<div class="bg-gray-800 rounded-lg flex items-center justify-center h-full text-center p-4"><p class="text-red-400">${error.message}</p></div>`;
            }
        }
        
        // El c√≥digo del modal de detalles se pega aqu√≠ para que est√© completo
        window.toggleDetails = async (gameId) => {
            const detailsPanel = document.getElementById('details-panel');
            const isOpen = !detailsPanel.classList.contains('hidden');
            if (isOpen || !gameId) { detailsPanel.classList.add('hidden'); detailsPanel.innerHTML = ''; return; }
            detailsPanel.innerHTML = `<div class="w-full max-w-5xl text-center py-20 text-lg text-indigo-400">Cargando detalles... <span class="spinner inline-block ml-2"></span></div>`;
            detailsPanel.classList.remove('hidden');
            try {
                const response = await fetch(`/api/getGameDetails?id=${gameId}`);
                if (!response.ok) throw new Error('No se pudieron cargar los detalles.');
                const details = await response.json();
                const steamStore = details.stores?.find(s => s.store.slug === 'steam');
                detailsPanel.innerHTML = `<div class="relative w-full max-w-5xl bg-gray-800 border border-gray-700 rounded-xl shadow-2xl p-6 m-4 modal-enter max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()"><button onclick="window.toggleDetails()" class="absolute top-2 right-4 text-3xl font-light text-gray-400 hover:text-white">&times;</button><div class="mb-4"><p class="text-sm text-gray-400">${new Date(details.released).toLocaleDateString('es-ES')}</p><h2 class="text-4xl lg:text-6xl font-bold text-white">${details.name}</h2></div><div class="flex flex-col lg:flex-row gap-6"><div class="w-full lg:w-2/5 flex-shrink-0"><img src="${details.background_image}" class="rounded-lg shadow-lg w-full mb-4">${steamStore ? `<a href="${steamStore.url}" target="_blank" class="block w-full text-center bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg">Ver en Steam</a>` : ''}</div><div class="w-full lg:w-3/5"><h3 class="font-bold text-xl mb-2 text-indigo-400">Acerca de</h3><div class="text-gray-300 max-h-48 overflow-y-auto mb-4">${details.description_raw || 'Sin descripci√≥n.'}</div><div class="grid grid-cols-2 md:grid-cols-4 gap-2">${details.short_screenshots?.slice(1, 5).map(ss => `<img src="${ss.image}" class="rounded-md h-24 w-full object-cover">`).join('') || ''}</div></div></div></div>`;
                detailsPanel.onclick = () => toggleDetails();
            } catch (error) { detailsPanel.innerHTML = `<div class="relative w-full max-w-md bg-gray-800 p-6 rounded-xl"><p class="text-red-400">Error: ${error.message}</p><button onclick="window.toggleDetails()" class="mt-4 bg-indigo-600 px-4 py-2 rounded">Cerrar</button></div>`; }
        };

        main();
    </script>
</body>
</html>