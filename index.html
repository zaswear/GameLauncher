<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GameVault</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #0d1117; color: #e6e6e6; }
        .spinner { border: 3px solid rgba(255, 255, 255, 0.3); border-top: 3px solid #818cf8; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #discover-card { transition: transform 0.4s ease, opacity 0.4s ease; cursor: grab; }
        #discover-card.grabbing { cursor: grabbing; }
        .modal-enter { animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: scale(0.95); } to { opacity: 1; transform: scale(1); } }
        .metascore-good { background-color: #6c3; color: white; }
        .metascore-average { background-color: #fc3; color: white; }
        .metascore-bad { background-color: #f00; color: white; }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8 flex flex-col">

    <main class="max-w-4xl mx-auto w-full flex-grow">
        <header class="mb-8 text-center">
            <h1 class="text-4xl md:text-6xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-purple-500">
                GameVault
            </h1>
            <p class="text-gray-400 mt-2">Descubre y guarda tus juegos favoritos</p>
        </header>

        <section id="discover-section" class="mb-12 flex flex-col items-center">
            <div id="discover-card-container" class="relative w-full max-w-sm h-96"></div>
            <div id="discover-buttons" class="flex gap-8 mt-6">
                <button id="dislike-btn" class="w-20 h-20 bg-red-800/20 text-red-400 rounded-full flex items-center justify-center text-4xl font-bold transition-transform hover:scale-110 hover:bg-red-800/40">‚ùå</button>
                <button id="like-btn" class="w-20 h-20 bg-green-800/20 text-green-400 rounded-full flex items-center justify-center text-4xl font-bold transition-transform hover:scale-110 hover:bg-green-800/40">üíö</button>
            </div>
        </section>

        <section id="library-section">
            <div class="border-b-2 border-gray-700 pb-2 mb-6">
                <h2 class="text-2xl md:text-3xl font-bold text-gray-200">üìö Tu B√≥veda de Juegos</h2>
                <div class="mt-4 flex flex-col md:flex-row gap-4">
                    <input type="text" id="library-search" placeholder="Buscar en tu b√≥veda..." class="w-full md:flex-grow p-3 rounded-lg bg-gray-800 text-white border-2 border-gray-700 focus:border-indigo-500 transition">
                    <select id="genre-filter" class="p-3 rounded-lg bg-gray-800 text-white border-2 border-gray-700 focus:border-indigo-500 transition"></select>
                </div>
            </div>
            <div id="library-grid-container" class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-4"></div>
        </section>
        
        <div id="details-panel" class="hidden fixed inset-0 bg-black bg-opacity-75 backdrop-blur-sm flex items-center justify-center p-4 z-50"></div>
    </main>

    <script type="module">
        let discoverGames = [];
        let likedGames = [];
        let dislikedGames = [];
        let currentIndex = 0;

        function renderNextCard() {
            const container = document.getElementById('discover-card-container');
            if (currentIndex >= discoverGames.length) {
                container.innerHTML = `<div class="bg-gray-800 rounded-lg flex flex-col items-center justify-center h-full text-center p-4"><h3 class="text-2xl font-bold text-white mb-2">¬°Has visto todo!</h3><p class="text-gray-400">Recarga la p√°gina para obtener una nueva selecci√≥n de juegos.</p></div>`;
                document.getElementById('discover-buttons').style.display = 'none';
                return;
            }
            const game = discoverGames[currentIndex];
            container.innerHTML = `<div id="discover-card" class="absolute inset-0 bg-gray-800 rounded-lg shadow-2xl overflow-hidden"><img src="${game.imageUrl}" class="w-full h-full object-cover"><div class="absolute bottom-0 left-0 right-0 p-4 bg-gradient-to-t from-black to-transparent"><h3 class="text-2xl font-bold text-white">${game.title}</h3></div></div>`;
        }

        function handleSwipe(direction) {
            const cardElement = document.getElementById('discover-card');
            if (!cardElement || currentIndex >= discoverGames.length) return;
            const game = discoverGames[currentIndex];

            if (direction === 'like') {
                likedGames.unshift(game);
                localStorage.setItem('likedGames', JSON.stringify(likedGames));
                renderMyLibrary();
                cardElement.style.transform = 'translateX(100px) rotate(15deg)';
            } else {
                dislikedGames.push(game.id);
                localStorage.setItem('dislikedGames', JSON.stringify(dislikedGames));
                cardElement.style.transform = 'translateX(-100px) rotate(-15deg)';
            }
            cardElement.style.opacity = '0';
            currentIndex++;
            setTimeout(renderNextCard, 200);
        }

        function renderMyLibrary() {
            const container = document.getElementById('library-grid-container');
            const searchTerm = document.getElementById('library-search').value.toLowerCase();
            const selectedGenre = document.getElementById('genre-filter').value;
            
            let filteredLibrary = likedGames;

            if (searchTerm) {
                filteredLibrary = filteredLibrary.filter(game => game.title.toLowerCase().includes(searchTerm));
            }
            if (selectedGenre) {
                filteredLibrary = filteredLibrary.filter(game => game.genres.includes(selectedGenre));
            }

            container.innerHTML = '';
            if (filteredLibrary.length === 0) {
                container.innerHTML = `<p class="col-span-full text-center text-gray-500 py-10">No hay juegos que coincidan con tus filtros.</p>`;
            } else {
                filteredLibrary.forEach(game => {
                    const card = document.createElement('div');
                    card.className = 'cursor-pointer group';
                    card.innerHTML = `<img src="${game.imageUrl}" alt="${game.title}" class="rounded-lg shadow-lg w-full h-auto aspect-[3/4] object-cover transition-transform duration-300 group-hover:scale-105 border-2 border-transparent group-hover:border-indigo-500">`;
                    card.onclick = () => toggleDetails(game.id);
                    container.appendChild(card);
                });
            }
        }

        function populateGenreFilter() {
            const filter = document.getElementById('genre-filter');
            const genres = new Set();
            likedGames.forEach(game => game.genres.forEach(genre => genres.add(genre)));
            
            filter.innerHTML = '<option value="">Todos los g√©neros</option>';
            [...genres].sort().forEach(genre => {
                filter.innerHTML += `<option value="${genre}">${genre}</option>`;
            });
        }

        function deleteFromLibrary(gameId) {
            likedGames = likedGames.filter(game => game.id !== gameId);
            localStorage.setItem('likedGames', JSON.stringify(likedGames));
            renderMyLibrary();
            populateGenreFilter();
            toggleDetails(); // Cierra el modal
        }
        
        async function toggleDetails(gameId) {
            const detailsPanel = document.getElementById('details-panel');
            const isOpen = !detailsPanel.classList.contains('hidden');
            if (isOpen || !gameId) { detailsPanel.classList.add('hidden'); detailsPanel.innerHTML = ''; return; }

            detailsPanel.innerHTML = `<div class="w-full max-w-5xl text-center py-20 text-lg text-indigo-400">Cargando detalles... <span class="spinner inline-block ml-2"></span></div>`;
            detailsPanel.classList.remove('hidden');

            try {
                const response = await fetch(`/api/getGameDetails?id=${gameId}`);
                if (!response.ok) throw new Error('No se pudieron cargar los detalles.');
                const details = await response.json();
                
                let scoreClass = 'metascore-average';
                if (details.metacritic >= 75) scoreClass = 'metascore-good';
                if (details.metacritic < 50 && details.metacritic > 0) scoreClass = 'metascore-bad';

                detailsPanel.innerHTML = `
                    <div class="relative w-full max-w-5xl bg-gray-800 border border-gray-700 rounded-xl shadow-2xl p-6 m-4 modal-enter max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
                        <button onclick="window.toggleDetails()" class="absolute top-2 right-4 text-3xl font-light text-gray-400 hover:text-white">&times;</button>
                        <h2 class="text-4xl lg:text-6xl font-bold text-white mb-4">${details.name}</h2>
                        <div class="flex flex-col lg:flex-row gap-6">
                            <div class="w-full lg:w-2/5 flex-shrink-0">
                                <img src="${details.background_image}" class="rounded-lg shadow-lg w-full mb-4">
                                <div class="space-y-3">
                                    ${details.metacritic ? `<div class="flex items-center gap-2"><svg class="w-6 h-6" viewBox="0 0 100 100"><circle cx="50" cy="50" r="50" fill="#242424"/><path d="M78.62 21.38V78.62H21.38V21.38H78.62ZM87.5 12.5H12.5V87.5H87.5V12.5Z" fill="white"/><path d="M45.56 65.5V36.68H38.3V30H61.7V36.68H54.44V65.5H45.56Z" fill="white"/></svg><span class="font-bold text-gray-300">Metacritic</span><span class="font-bold text-lg px-2 rounded ${scoreClass}">${details.metacritic}</span></div>` : ''}
                                    ${details.stores?.find(s => s.store.slug === 'steam') ? `<a href="${details.stores.find(s => s.store.slug === 'steam').url}" target="_blank" class="block w-full text-center bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-4 rounded-lg">Ver en Steam</a>` : ''}
                                    <button id="delete-btn" class="w-full bg-red-800 hover:bg-red-700 text-white font-bold py-3 px-4 rounded-lg">Eliminar de la B√≥veda</button>
                                </div>
                            </div>
                            <div class="w-full lg:w-3/5">
                                <h3 class="font-bold text-xl mb-2 text-indigo-400">Acerca de</h3>
                                <div class="text-gray-300 max-h-48 overflow-y-auto mb-4">${details.description_raw || 'Sin descripci√≥n.'}</div>
                                <div class="grid grid-cols-2 md:grid-cols-4 gap-2">${details.short_screenshots?.slice(0, 4).map(ss => `<img src="${ss.image}" class="rounded-md h-24 w-full object-cover">`).join('') || ''}</div>
                            </div>
                        </div>
                    </div>
                `;
                detailsPanel.onclick = () => toggleDetails();
                document.getElementById('delete-btn').onclick = () => deleteFromLibrary(gameId);
            } catch (error) { /* ... manejo de error ... */ }
        }
        window.toggleDetails = toggleDetails;

        async function main() {
            document.getElementById('like-btn').onclick = () => handleSwipe('like');
            document.getElementById('dislike-btn').onclick = () => handleSwipe('dislike');
            document.getElementById('library-search').oninput = renderMyLibrary;
            document.getElementById('genre-filter').onchange = renderMyLibrary;
            document.addEventListener('keydown', (e) => { if (e.key === 'ArrowLeft') handleSwipe('dislike'); if (e.key === 'ArrowRight') handleSwipe('like'); });

            likedGames = JSON.parse(localStorage.getItem('likedGames')) || [];
            dislikedGames = JSON.parse(localStorage.getItem('dislikedGames')) || [];
            renderMyLibrary();
            populateGenreFilter();

            try {
                const response = await fetch('/api/getDiscoverGames');
                if (!response.ok) throw new Error('No se pudo cargar la lista de juegos para descubrir.');
                const allFetchedGames = await response.json();
                const seenGames = new Set([...dislikedGames, ...likedGames.map(g => g.id)]);
                discoverGames = allFetchedGames.filter(game => !seenGames.has(game.id));
                renderNextCard();
            } catch (error) {
                console.error(error);
                document.getElementById('discover-card-container').innerHTML = `<div class="bg-gray-800 rounded-lg flex items-center justify-center h-full text-center p-4"><p class="text-red-400">${error.message}</p></div>`;
            }
        }

        main();
    </script>
</body>
</html>