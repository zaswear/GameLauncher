<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GameLauncher</title>
    <!-- Incluye Tailwind CSS para un dise√±o moderno y responsive -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Estilo personalizado para la tabla y el scroll */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0d1117; /* Fondo oscuro tipo consola */
            color: #e6e6e6;
            padding: 0;
            margin: 0;
        }
        /* Estilo para hacer la tabla editable m√°s visible */
        [contenteditable]:focus {
            outline: 2px solid #5778ff; /* Borde azul brillante al editar */
            background-color: #1a222c;
            border-radius: 4px;
        }
        /* Estilo para la columna de T√≠tulo (clickable) */
        .title-cell {
            cursor: pointer;
            color: #6366f1; /* Indigo 500 */
            text-decoration: underline;
            font-weight: bold;
        }
        .title-cell:hover {
            color: #a5b4fc; /* Indigo 300 */
        }
        /* Barra de desplazamiento estilo "neon" */
        .scroll-container::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        .scroll-container::-webkit-scrollbar-thumb {
            background-color: #5778ff;
            border-radius: 10px;
        }
        .scroll-container::-webkit-scrollbar-track {
            background: #1a222c;
        }
        /* Efecto hover en filas */
        .data-row:hover {
            background-color: #1a222c;
        }
        /* Estilo para el bot√≥n de carga */
        .btn-loading {
            position: relative;
        }
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid #fff;
            border-radius: 50%;
            width: 16px;
            height: 16px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="min-h-screen p-4 md:p-8">

    <div class="max-w-7xl mx-auto">
        <!-- Encabezado de la Aplicaci√≥n -->
        <header class="mb-8 p-4 bg-gray-800 rounded-xl shadow-2xl">
            <h1 class="text-3xl md:text-5xl font-extrabold text-transparent bg-clip-text bg-gradient-to-r from-blue-400 to-indigo-600 mb-2">
                üéÆ GameLauncher
            </h1>
            <p class="text-gray-400">Tu gestor de lanzamientos de videojuegos editables. ID de Usuario: <span id="user-id-display" class="font-mono text-xs bg-gray-700 px-2 py-0.5 rounded">Cargando...</span></p>
        </header>

        <!-- Controles y Filtros -->
        <div class="mb-6 flex flex-col md:flex-row justify-between items-center space-y-4 md:space-y-0">
            <input type="text" id="search-input" placeholder="Buscar por t√≠tulo o plataforma..."
                   class="w-full md:w-80 p-3 rounded-lg bg-gray-700 text-white border-2 border-gray-600 focus:border-indigo-500 transition duration-200"
                   oninput="filterTable()">
            <button id="add-row-btn" class="bg-indigo-600 hover:bg-indigo-700 text-white font-bold py-3 px-6 rounded-lg shadow-lg transition duration-200 transform hover:scale-105 flex items-center space-x-2" onclick="addNewRow()">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M10 3a1 1 0 011 1v5h5a1 1 0 110 2h-5v5a1 1 0 11-2 0v-5H4a1 1 0 110-2h5V4a1 1 0 011-1z" clip-rule="evenodd" />
                </svg>
                <span>A√±adir Juego</span>
            </button>
        </div>

        <!-- √Årea de la Tabla (Responsive Scroll) -->
        <div id="loading-indicator" class="text-center py-10 text-lg text-indigo-400 hidden">
            Cargando datos de lanzamientos... <span class="spinner inline-block ml-2"></span>
        </div>
        <div id="error-message" class="hidden bg-red-800 p-4 rounded-lg mb-4 text-sm"></div>

        <div class="scroll-container overflow-x-auto rounded-xl shadow-2xl">
            <table class="min-w-full divide-y divide-gray-700">
                <thead class="bg-gray-800 sticky top-0">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">T√≠tulo (Click p/ Detalles)</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Plataformas</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">Fecha Estreno</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">G√©nero</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">üìå Notas (Editable)</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">‚ùå</th>
                    </tr>
                </thead>
                <tbody id="game-table-body" class="bg-gray-900 divide-y divide-gray-700">
                    <!-- Las filas de juegos se insertar√°n aqu√≠ -->
                </tbody>
            </table>
        </div>

        <!-- Contenedor para el Panel de Detalles Din√°mico -->
        <div id="details-panel" class="hidden mt-8 p-6 bg-gray-800 rounded-xl shadow-2xl transition-all duration-300">
            <!-- El contenido detallado se inyectar√° aqu√≠ -->
        </div>

    </div>

    <!-- M√ìDULOS DE FIREBASE -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, deleteDoc, onSnapshot, collection, query, addDoc, getDocs, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Establecer nivel de log para depuraci√≥n de Firestore
        setLogLevel('Debug');

        // --- Configuraci√≥n e Inicializaci√≥n de Firebase (NO EDITAR) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db;
        let auth;
        let userId = 'default-user'; // Inicializaci√≥n por defecto
        let gamesData = [];
        let activeDetailsId = null; // ID del juego cuyos detalles est√°n abiertos

        // Datos iniciales de juegos (Septiembre 2025 - Septiembre 2026)
        // Nota: Los enlaces con valor 'null' no son renderizados como botones activos.
        const initialGames = [
            // Septiembre 2025
            { id: 'g001', title: "Cyberpunk 2077: Phantom Liberty 2", platforms: "PC, PS5, XSX", releaseDate: "12 Sep 2025", genre: "Action RPG", notes: "Gran expansi√≥n de la secuela.", steamLink: "https://store.steampowered.com/app/2027150/Cyberpunk_2077_Phantom_Liberty/", ps5Link: "https://store.playstation.com/es-es/product/EP1000-PPSA02187_00-CYBERPUNKEXPANSION", xboxLink: "https://www.xbox.com/es-es/games/store/cyberpunk-2077/9nx4bshc8d50", ggDealsLink: "https://gg.deals/game/cyberpunk-2077-phantom-liberty-2-mock/", instantGamingLink: "https://www.instant-gaming.com/es/10000-cyberpunk-2077-phantom-liberty-2-mock/" },
            { id: 'g002', title: "Starfield 2", platforms: "PC, XSX", releaseDate: "25 Sep 2025", genre: "Space RPG", notes: "Bethesda de nuevo.", steamLink: "https://store.steampowered.com/app/1716740/Starfield/", ps5Link: null, xboxLink: "https://www.xbox.com/es-es/games/store/starfield/9n211c47p69d", ggDealsLink: "https://gg.deals/game/starfield-2-mock/", instantGamingLink: "https://www.instant-gaming.com/es/10001-starfield-2-mock/" },
            
            // Octubre 2025
            { id: 'g003', title: "Vampire: The Masquerade ‚Äì Bloodlines 2", platforms: "PC, PS5, XSX", releaseDate: "21 Oct 2025", genre: "RPG", notes: "¬°El m√°s esperado! Revisar requisitos.", steamLink: "https://store.steampowered.com/app/550540/Vampire_The_Masquerade__Bloodlines_2/", ps5Link: "https://store.playstation.com/es-es/product/EP1000-PPSA02187_00-VAMPIREBLOODLINES2", xboxLink: "https://www.xbox.com/es-es/games/store/vampire-the-masquerade-bloodlines-2/9nb393j65w20", ggDealsLink: "https://gg.deals/game/vampire-the-masquerade-bloodlines-2-mock/", instantGamingLink: "https://www.instant-gaming.com/es/10002-vampire-the-masquerade-bloodlines-2-mock/" },
            { id: 'g004', title: "Battlefield 6", platforms: "PC, PS5, XSX", releaseDate: "10 Oct 2025", genre: "FPS T√°ctico", notes: "Beta a finales de septiembre.", steamLink: "https://store.steampowered.com/app/1517290/Battlefield_2042/", ps5Link: "https://store.playstation.com/es-es/product/EP0006-PPSA01389_00-BF2042PREORDER00", xboxLink: "https://www.xbox.com/es-es/games/store/battlefield-2042/9n8q512kp827", ggDealsLink: "https://gg.deals/game/battlefield-6-mock/", instantGamingLink: "https://www.instant-gaming.com/es/10003-battlefield-6-mock/" },
            { id: 'g005', title: "Jurassic World Evolution 3", platforms: "PC, PS5, XSX", releaseDate: "21 Oct 2025", genre: "Tycoon/Estrategia", notes: "Para los fans de la gesti√≥n.", steamLink: "https://store.steampowered.com/app/1381380/Jurassic_World_Evolution_2/", ps5Link: "https://store.playstation.com/es-es/product/EP2377-PPSA04828_00-JWE2000000000000", xboxLink: "https://www.xbox.com/es-es/games/store/jurassic-world-evolution-2/9nlcst69d30l", ggDealsLink: "https://gg.deals/game/jurassic-world-evolution-3-mock/", instantGamingLink: "https://www.instant-gaming.com/es/10004-jurassic-world-evolution-3-mock/" },
            
            // Noviembre 2025
            { id: 'g006', title: "Final Fantasy XVI-2 (Secuela)", platforms: "PS5, PC", releaseDate: "15 Nov 2025", genre: "Action RPG", notes: "Secuela directa, con foco en el combate a√©reo.", steamLink: "https://store.steampowered.com/app/1815590/Final_Fantasy_XVI/", ps5Link: "https://store.playstation.com/es-es/product/EP0082-PPSA01584_00-FFXVI00000000000", xboxLink: null, ggDealsLink: "https://gg.deals/game/final-fantasy-xvi-2-mock/", instantGamingLink: "https://www.instant-gaming.com/es/10005-final-fantasy-xvi-2-mock/" },
            { id: 'g007', title: "The Elder Scrolls VI", platforms: "PC, XSX", releaseDate: "28 Nov 2025", genre: "Open World RPG", notes: "Rumores apuntan a Hammerfell. ¬°Prep√°rate para perder 500 horas!", steamLink: "https://store.steampowered.com/app/28000/The_Elder_Scrolls_V_Skyrim_Special_Edition/", ps5Link: null, xboxLink: "https://www.xbox.com/es-es/games/store/the-elder-scrolls-online/c0qj2x527v2q", ggDealsLink: "https://gg.deals/game/the-elder-scrolls-vi-mock/", instantGamingLink: "https://www.instant-gaming.com/es/10006-the-elder-scrolls-vi-mock/" },
            
            // Diciembre 2025
            { id: 'g008', title: "Grand Theft Auto VII", platforms: "PC, PS5, XSX", releaseDate: "10 Dic 2025", genre: "Action-Adventure", notes: "La fecha es un placeholder, pero la hype es real.", steamLink: null, ps5Link: "https://store.playstation.com/es-es/product/EP1004-CUSA00419_00-GTAVDIGITAL00001", xboxLink: "https://www.xbox.com/es-es/games/store/grand-th-auto-v/9pb2n2p43dng", ggDealsLink: "https://gg.deals/game/grand-theft-auto-vii-mock/", instantGamingLink: "https://www.instant-gaming.com/es/10007-grand-theft-auto-vii-mock/" },
            
            // Enero 2026
            { id: 'g009', title: "Horizon 3: Forbidden Westward", platforms: "PS5, PC", releaseDate: "20 Ene 2026", genre: "Action RPG", notes: "Continuaci√≥n de la saga de Aloy.", steamLink: null, ps5Link: "https://store.playstation.com/es-es/product/EP9000-PPSA04033_00-FORBIDDENWESTPKG", xboxLink: null, ggDealsLink: "https://gg.deals/game/horizon-3-mock/", instantGamingLink: "https://www.instant-gaming.com/es/10008-horizon-3-mock/" },
            
            // Febrero 2026
            { id: 'g010', title: "Sid Meier's Civilization VII", platforms: "PC, PS5, XSX, NS", releaseDate: "11 Feb 2026", genre: "Estrategia 4X", notes: "El nuevo gran Civilization.", steamLink: "https://store.steampowered.com/app/289070/Sid_Meiers_Civilization_VI/", ps5Link: "https://store.playstation.com/es-es/product/EP1001-PPSA01037_00-CIV6BASEGAME0000", xboxLink: "https://www.xbox.com/es-es/games/store/sid-meiers-civilization-vi/9n9lq7v04s3d", ggDealsLink: "https://gg.deals/game/sid-meiers-civilization-vii-mock/", instantGamingLink: "https://www.instant-gaming.com/es/10009-sid-meiers-civilization-vii-mock/" },

            // Marzo 2026
            { id: 'g011', title: "Dragon Age: Dreadwolf", platforms: "PC, PS5, XSX", releaseDate: "15 Mar 2026", genre: "RPG Fantas√≠a", notes: "El regreso de BioWare.", steamLink: "https://store.steampowered.com/app/1238910/Dragon_Age_Dreadwolf/", ps5Link: "https://store.playstation.com/es-es/product/EP0006-PPSA02187_00-DRAGONAGEDREADWOLF", xboxLink: "https://www.xbox.com/es-es/games/store/dragon-age-dreadwolf/9n9lq7v04s3d", ggDealsLink: "https://gg.deals/game/dragon-age-dreadwolf-mock/", instantGamingLink: "https://www.instant-gaming.com/es/10010-dragon-age-dreadwolf-mock/" },
            
            // Abril 2026
            { id: 'g012', title: "Fable (Reboot)", platforms: "PC, XSX", releaseDate: "22 Abr 2026", genre: "Action RPG Fantas√≠a", notes: "El cuento de hadas de Playground Games.", steamLink: null, ps5Link: null, xboxLink: "https://www.xbox.com/es-es/games/fable", ggDealsLink: "https://gg.deals/game/fable-reboot-mock/", instantGamingLink: "https://www.instant-gaming.com/es/10011-fable-reboot-mock/" },
            
            // Mayo 2026
            { id: 'g013', title: "Elden Ring: Nightreign (Expansi√≥n)", platforms: "PC, PS5, XSX", releaseDate: "30 May 2026", genre: "Action RPG", notes: "Nueva gran expansi√≥n.", steamLink: "https://store.steampowered.com/app/1245620/ELDEN_RING/", ps5Link: "https://store.playstation.com/es-es/product/EP0700-PPSA04791_00-ELDENRING0000000", xboxLink: "https://www.xbox.com/es-es/games/store/elden-ring/9p3j86pj864r", ggDealsLink: "https://gg.deals/game/elden-ring-nightreign-mock/", instantGamingLink: "https://www.instant-gaming.com/es/10012-elden-ring-nightreign-mock/" },
            
            // Junio 2026
            { id: 'g014', title: "Overwatch 3", platforms: "PC, PS5, XSX", releaseDate: "15 Jun 2026", genre: "FPS Team-Based", notes: "La esperada tercera entrega.", steamLink: "https://store.steampowered.com/app/1500330/Overwatch_2/", ps5Link: "https://store.playstation.com/es-es/product/EP0002-PPSA05908_00-OVERWATCH2DELUXE", xboxLink: "https://www.xbox.com/es-es/games/store/overwatch-2-watchpoint-pack/9nx7v2p09f7s", ggDealsLink: "https://gg.deals/game/overwatch-3-mock/", instantGamingLink: "https://www.instant-gaming.com/es/10013-overwatch-3-mock/" },

            // Julio 2026
            { id: 'g015', title: "Hades II (Full Release)", platforms: "PC, NS, PS5", releaseDate: "10 Jul 2026", genre: "Roguelite", notes: "Lanzamiento completo despu√©s del Early Access.", steamLink: "https://store.steampowered.com/app/1145350/Hades_II/", ps5Link: "https://store.playstation.com/es-es/product/EP0805-PPSA02187_00-HADES2GAME000001", xboxLink: null, ggDealsLink: "https://gg.deals/game/hades-ii-mock/", instantGamingLink: "https://www.instant-gaming.com/es/10014-hades-ii-mock/" },
            
            // Agosto 2026
            { id: 'g016', title: "Mafia: The Old Country", platforms: "PC, PS5, XSX", releaseDate: "7 Aug 2026", genre: "Action-Adventure", notes: "Precuela ambientada en Italia.", steamLink: "https://store.steampowered.com/app/103080/Mafia_The_Old_Country_Mock/", ps5Link: "https://store.playstation.com/es-es/product/EP1004-PPSA04033_00-MAFIAOLDCOUNTRY0", xboxLink: "https://www.xbox.com/es-es/games/store/mafia-the-old-country/9pb2n2p43dng", ggDealsLink: "https://gg.deals/game/mafia-the-old-country-mock/", instantGamingLink: "https://www.instant-gaming.com/es/10015-mafia-the-old-country-mock/" },
            
            // Septiembre 2026
            { id: 'g017', title: "Death Stranding 2", platforms: "PS5", releaseDate: "5 Sep 2026", genre: "Action-Adventure", notes: "El regreso de Hideo Kojima.", steamLink: null, ps5Link: "https://store.playstation.com/es-es/product/EP9000-PPSA02187_00-DEATHSTRANDING20", xboxLink: null, ggDealsLink: "https://gg.deals/game/death-stranding-2-mock/", instantGamingLink: "https://www.instant-gaming.com/es/10016-death-stranding-2-mock/" },
        ];

        // Funci√≥n de utilidad para manejar errores
        function displayError(message) {
            const errorElement = document.getElementById('error-message');
            errorElement.textContent = `Error: ${message}`;
            errorElement.classList.remove('hidden');
            setTimeout(() => errorElement.classList.add('hidden'), 8000);
            console.error(message);
        }

        // --- 1. Inicializaci√≥n y Autenticaci√≥n de Firebase ---
        async function initFirebase() {
            try {
                if (firebaseConfig) {
                    const app = initializeApp(firebaseConfig);
                    db = getFirestore(app);
                    auth = getAuth(app);

                    // Autenticaci√≥n con el token inicial o an√≥nima
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                    
                    // Obtener el ID del usuario actual
                    userId = auth.currentUser?.uid || crypto.randomUUID();
                    document.getElementById('user-id-display').textContent = userId;

                    // Iniciar la escucha de datos
                    listenForGames();

                } else {
                    displayError("Configuraci√≥n de Firebase no disponible. La aplicaci√≥n funcionar√°, pero los datos no ser√°n persistentes.");
                    // Cargar datos iniciales en modo no persistente
                    gamesData = initialGames.map(g => ({ ...g, id: g.id || crypto.randomUUID() }));
                    renderTable(gamesData);
                }
            } catch (e) {
                displayError(`Fallo en la inicializaci√≥n de Firebase: ${e.message}`);
                // Fallback a datos iniciales si Firebase falla
                gamesData = initialGames.map(g => ({ ...g, id: g.id || crypto.randomUUID() }));
                renderTable(gamesData);
            }
        }

        // --- 2. Rutas y Almacenamiento de Datos ---
        
        // Define la ruta de la colecci√≥n de datos privada para este usuario
        function getGamesCollectionRef() {
            if (!db) return null;
            // Ruta privada: /artifacts/{appId}/users/{userId}/game_launch_data
            const collectionPath = `artifacts/${appId}/users/${userId}/game_launch_data`;
            return collection(db, collectionPath);
        }

        // Funci√≥n para verificar y cargar datos iniciales si la colecci√≥n est√° vac√≠a
        async function checkAndLoadInitialData() {
            try {
                const q = query(getGamesCollectionRef());
                const querySnapshot = await getDocs(q);

                if (querySnapshot.empty) {
                    console.log("No hay datos en Firestore. Cargando datos iniciales.");
                    // A√±adir los datos iniciales a Firestore
                    for (const game of initialGames) {
                        // Clonar el objeto para asegurar que el ID de Firestore es √∫nico
                        const gameData = { ...game };
                        delete gameData.id; // Firestore asignar√° uno autom√°ticamente si no se usa doc(ref, id)
                        
                        // A√±adir como un documento nuevo, permitiendo que Firestore asigne el ID
                        await addDoc(getGamesCollectionRef(), gameData);
                    }
                } else {
                    console.log("Datos encontrados en Firestore. Saltando carga inicial.");
                }
            } catch (e) {
                console.error("Error al verificar/cargar datos iniciales:", e);
                displayError("No se pudieron cargar los datos iniciales en Firestore. Revisa la consola.");
            }
        }

        // --- 3. CRUD (Create, Read, Update, Delete) ---

        // Escucha en tiempo real de la colecci√≥n de juegos
        function listenForGames() {
            if (!getGamesCollectionRef()) return;

            const loadingIndicator = document.getElementById('loading-indicator');
            loadingIndicator.classList.remove('hidden');

            const q = query(getGamesCollectionRef());
            
            // onSnapshot es la clave para la reactividad en tiempo real
            onSnapshot(q, (snapshot) => {
                loadingIndicator.classList.add('hidden');
                
                // Verificar si es la primera carga para intentar cargar los datos iniciales
                if (snapshot.metadata.hasPendingWrites === false && snapshot.docs.length === 0) {
                    checkAndLoadInitialData();
                    return; // Esperar el nuevo snapshot con los datos iniciales
                }

                // Mapear los documentos a un array de objetos
                gamesData = snapshot.docs.map(doc => ({
                    id: doc.id,
                    ...doc.data()
                }));
                
                // Ordenar por fecha de lanzamiento. Intentar convertir a Date para un orden correcto.
                gamesData.sort((a, b) => {
                    const dateA = new Date(a.releaseDate);
                    const dateB = new Date(b.releaseDate);
                    if (isNaN(dateA)) return 1; // Mover 'Pendiente' o inv√°lidos al final
                    if (isNaN(dateB)) return -1;
                    return dateA - dateB;
                });

                // Renderizar la tabla con los datos actualizados
                filterTable(); // Usar filterTable para mantener la b√∫squeda si existe
            }, (error) => {
                loadingIndicator.classList.add('hidden');
                displayError(`Error al escuchar datos: ${error.message}`);
            });
        }
        
        // Funci√≥n global para a√±adir una nueva fila (llamada desde el bot√≥n)
        window.addNewRow = async function() {
            const newGame = {
                title: "Nuevo T√≠tulo (Editable)",
                platforms: "PC, Consola",
                releaseDate: "Pendiente",
                genre: "Indefinido",
                notes: "Escribe aqu√≠ tus notas personales.",
                steamLink: null,
                ps5Link: null,
                xboxLink: null,
                ggDealsLink: null,
                instantGamingLink: null,
                createdAt: new Date().toISOString()
            };

            if (db) {
                try {
                    await addDoc(getGamesCollectionRef(), newGame);
                } catch (e) {
                    displayError(`Fallo al a√±adir documento: ${e.message}`);
                }
            } else {
                 // Si Firebase no est√° activo, a√±adir a la lista local
                const tempId = crypto.randomUUID();
                gamesData.push({...newGame, id: tempId});
                filterTable();
            }
        }

        // Funci√≥n global para actualizar un documento (llamada desde la tabla)
        window.updateGameField = async function(docId, field, value) {
            if (!db) return console.log("Modo no persistente: El cambio no se guardar√°.");
            
            try {
                const docRef = doc(getGamesCollectionRef(), docId);
                await setDoc(docRef, { [field]: value }, { merge: true });
                console.log(`Documento ${docId} actualizado: ${field} = ${value}`);
            } catch (e) {
                displayError(`Fallo al actualizar campo: ${e.message}`);
            }
        }
        
        // Funci√≥n global para eliminar una fila (llamada desde el bot√≥n ‚ùå)
        window.deleteGameRow = async function(docId) {
            if (db) {
                try {
                    // Cerrar el panel de detalles si estaba abierto para este juego
                    if (activeDetailsId === docId) {
                        window.toggleDetails(docId);
                    }
                    const docRef = doc(getGamesCollectionRef(), docId);
                    await deleteDoc(docRef);
                } catch (e) {
                    displayError(`Fallo al eliminar documento: ${e.message}`);
                }
            } else {
                 // Si Firebase no est√° activo, eliminar de la lista local
                gamesData = gamesData.filter(g => g.id !== docId);
                filterTable();
            }
        }

        // --- 4. Interactividad y Renderizado de la UI ---

        // Funci√≥n auxiliar para renderizar enlaces. Muestra 'No disponible' si la URL es nula.
        const renderLink = (url, text, bgColor, hoverColor) => {
            if (!url) {
                return `
                    <div class="flex items-center space-x-2 p-3 bg-gray-600 rounded-lg opacity-50 cursor-default">
                        <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-8-3a1 1 0 00-1 1v4a1 1 0 102 0V8a1 1 0 00-1-1zm0 8a1 1 0 100-2 1 1 0 000 2z" clip-rule="evenodd" />
                        </svg>
                        <span class="font-semibold text-white">${text} (No disponible)</span>
                    </div>
                `;
            }
            return `
                <a href="${url}" target="_blank" rel="noopener noreferrer" 
                    class="flex items-center space-x-2 p-3 ${bgColor} rounded-lg hover:${hoverColor} transition duration-200 transform hover:scale-105 shadow-md">
                    <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
                        <path d="M11 3a1 1 0 100 2h3a1 1 0 001-1V6a1 1 0 10-2 0v2.586L6.586 7.293a1 1 0 00-1.414 1.414l6 6a1 1 0 001.414 0l1.293-1.293V14a1 1 0 102 0v-3a1 1 0 00-1-1h-3z"/>
                    </svg>
                    <span class="font-semibold text-white">${text}</span>
                </a>
            `;
        }


        // Renderiza el contenido del panel de detalles
        function renderDetailsPanel(game) {
            console.log(`Abriendo detalles para: ${game.title}`, game); // Logging para debug
            
            return `
                <h2 class="text-3xl font-bold text-indigo-400 mb-4">${game.title} - Detalles</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    
                    <!-- Secci√≥n de Tiendas Oficiales -->
                    <div class="bg-gray-900 p-4 rounded-lg shadow-xl border border-gray-700">
                        <h3 class="text-xl font-semibold text-gray-300 mb-3 border-b border-gray-700 pb-2">üõí Tiendas Oficiales</h3>
                        <div class="space-y-3">
                            ${renderLink(game.steamLink, 'Steam Store (PC)', 'bg-gray-700', 'bg-blue-800')}
                            ${renderLink(game.ps5Link, 'PlayStation Store (PS5)', 'bg-gray-700', 'bg-blue-600')}
                            ${renderLink(game.xboxLink, 'Xbox Store (XSX/XBO)', 'bg-gray-700', 'bg-green-700')}
                        </div>
                    </div>

                    <!-- Secci√≥n de Ofertas y Keys -->
                    <div class="bg-gray-900 p-4 rounded-lg shadow-xl border border-gray-700">
                        <h3 class="text-xl font-semibold text-gray-300 mb-3 border-b border-gray-700 pb-2">üí∞ Comparaci√≥n de Precios</h3>
                        <div class="space-y-3">
                            ${renderLink(game.ggDealsLink, 'Ofertas en gg.deals', 'bg-gray-700', 'bg-purple-700')}
                            ${renderLink(game.instantGamingLink, 'Instant Gaming (Keys)', 'bg-gray-700', 'bg-yellow-600')}
                        </div>
                    </div>

                    <!-- Secci√≥n de Notas y Datos Generales -->
                    <div class="md:col-span-2 bg-gray-900 p-4 rounded-lg shadow-xl border border-gray-700">
                        <h3 class="text-xl font-semibold text-gray-300 mb-3 border-b border-gray-700 pb-2">üìù Notas Personales</h3>
                        <p class="text-sm text-gray-400 italic">${game.notes || 'No hay notas personales.'}</p>
                    </div>
                </div>
                
                <button onclick="window.toggleDetails('${game.id}')" class="mt-6 bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded-lg shadow-lg transition duration-200">
                    Cerrar Detalles
                </button>
            `;
        }

        // Funci√≥n global para alternar el panel de detalles
        window.toggleDetails = function(gameId) {
            const detailsPanel = document.getElementById('details-panel');
            const selectedGame = gamesData.find(g => g.id === gameId);

            if (!selectedGame) return displayError("Juego no encontrado para mostrar detalles.");
            
            // Si el mismo juego ya est√° abierto, cerrarlo
            if (activeDetailsId === gameId) {
                detailsPanel.classList.add('hidden');
                detailsPanel.innerHTML = '';
                activeDetailsId = null;
            } else {
                // Abrir un nuevo juego
                detailsPanel.innerHTML = renderDetailsPanel(selectedGame);
                detailsPanel.classList.remove('hidden');
                activeDetailsId = gameId;
                
                // Asegurar que el panel sea visible (√∫til en m√≥viles)
                detailsPanel.scrollIntoView({ behavior: 'smooth', block: 'start' });
            }
        }
        
        // Renderiza el contenido de la tabla basado en los datos filtrados/actualizados
        function renderTable(dataToRender) {
            const tableBody = document.getElementById('game-table-body');
            tableBody.innerHTML = ''; // Limpiar la tabla

            if (dataToRender.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="6" class="p-6 text-center text-gray-500">No se encontraron juegos que coincidan con la b√∫squeda.</td></tr>`;
                return;
            }

            dataToRender.forEach(game => {
                const row = document.createElement('tr');
                row.classList.add('data-row', 'transition', 'duration-150');

                // Funci√≥n para crear celdas editables y con evento onblur
                const createEditableCell = (field, content) => {
                    const cell = document.createElement('td');
                    cell.classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-sm', 'font-medium');
                    cell.setAttribute('contenteditable', 'true');
                    cell.textContent = content;
                    
                    // Evento para guardar el dato cuando el usuario deja de editar
                    cell.onblur = (e) => {
                        window.updateGameField(game.id, field, e.target.textContent.trim());
                    };
                    return cell;
                };

                // Columna 1: T√≠tulo (Clickable - NO EDITABLE)
                const titleCell = document.createElement('td');
                titleCell.classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-sm', 'font-medium', 'title-cell');
                titleCell.textContent = game.title;
                titleCell.onclick = () => window.toggleDetails(game.id);
                row.appendChild(titleCell);

                // Columna 2: Plataformas (Editable)
                row.appendChild(createEditableCell('platforms', game.platforms));
                
                // Columna 3: Fecha Estreno (Editable)
                row.appendChild(createEditableCell('releaseDate', game.releaseDate));

                // Columna 4: G√©nero (Editable)
                row.appendChild(createEditableCell('genre', game.genre));

                // Columna 5: Notas (Editable - Tu columna de informaci√≥n extra)
                row.appendChild(createEditableCell('notes', game.notes));

                // Columna 6: Bot√≥n Eliminar
                const deleteCell = document.createElement('td');
                deleteCell.classList.add('px-6', 'py-4', 'whitespace-nowrap', 'text-right', 'text-sm', 'font-medium');
                const deleteButton = document.createElement('button');
                deleteButton.textContent = '‚ùå';
                deleteButton.classList.add('text-lg', 'hover:text-red-500', 'transition', 'duration-150');
                deleteButton.onclick = () => window.deleteGameRow(game.id);
                deleteButton.title = 'Eliminar fila';
                deleteCell.appendChild(deleteButton);
                row.appendChild(deleteCell);

                tableBody.appendChild(row);
            });
        }
        
        // Funci√≥n global para filtrar la tabla (llamada desde el input)
        window.filterTable = function() {
            const searchTerm = document.getElementById('search-input').value.toLowerCase().trim();
            
            if (!searchTerm) {
                renderTable(gamesData); // Si no hay b√∫squeda, renderizar todos
                return;
            }

            const filteredData = gamesData.filter(game => {
                // Filtra si el t√©rmino coincide en el t√≠tulo o las plataformas
                const titleMatch = game.title.toLowerCase().includes(searchTerm);
                const platformMatch = game.platforms.toLowerCase().includes(searchTerm);
                return titleMatch || platformMatch;
            });

            renderTable(filteredData);
        }


        // --- Inicializaci√≥n al cargar la p√°gina ---
        initFirebase();

    </script>
</body>
</html>
